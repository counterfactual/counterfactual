import*as tslib_1 from"../polyfills/tslib.js";import{h}from"../app.core.js";import{a as getProp}from"./chunk-960e9c51.js";import"./chunk-deed3e85.js";import{b as HighRollerStage,e as CounterfactualTunnel}from"./chunk-a0cc8100.js";var HashZero=ethers.constants.HashZero,AppWager=function(){function t(){this.el={},this.history={},this.appFactory={},this.betAmount="0.01",this.myName="",this.opponent={attributes:{}},this.intermediary="",this.isError=!1,this.isWaiting=!1,this.standalone=!1,this.updateAppInstance=function(){},this.updateOpponent=function(){}}return t.prototype.componentWillLoad=function(){return tslib_1.__awaiter(this,void 0,void 0,function(){return tslib_1.__generator(this,function(t){switch(t.label){case 0:return this.myName=this.account.user.username,[4,this.matchmake()];case 1:return[2,t.sent()]}})})},t.prototype.handlePlay=function(t){return tslib_1.__awaiter(this,void 0,void 0,function(){var e,n,s;return tslib_1.__generator(this,function(r){switch(r.label){case 0:t.preventDefault(),r.label=1;case 1:return r.trys.push([1,3,,4]),e={stage:HighRollerStage.WAITING_FOR_P1_COMMITMENT,salt:HashZero,commitHash:HashZero,playerFirstNumber:0,playerSecondNumber:0,versionNumber:0},n=ethers.utils.parseEther(this.account.balance),s=ethers.utils.parseEther(this.betAmount),n.lt(s)?(this.error="Insufficient funds: You need at least "+this.betAmount+" ETH to play.",[2]):s.gt(ethers.utils.parseEther("0.01"))||s.lt(ethers.utils.parseEther("0"))?(this.error="Please, place a bet between 0 and 0.01 ETH.",[2]):[4,this.appFactory.proposeInstallVirtual({initialState:e,proposedToIdentifier:this.opponent.attributes.nodeAddress,responderDeposit:ethers.utils.parseEther(this.betAmount),initiatorDeposit:ethers.utils.parseEther(this.betAmount),timeout:172800,intermediaries:[this.intermediary]})];case 2:return r.sent(),this.isWaiting=!0,[3,4];case 3:return r.sent(),[3,4];case 4:return[2]}})})},t.prototype.matchmake=function(){return tslib_1.__awaiter(this,void 0,void 0,function(){var t,e;return tslib_1.__generator(this,function(n){switch(n.label){case 0:return n.trys.push([0,2,,3]),[4,this.fetchMatchmake()];case 1:return t=n.sent(),this.opponent={attributes:{username:t.data.attributes.username,nodeAddress:t.data.attributes.nodeAddress,ethAddress:t.data.attributes.ethAddress}},this.intermediary=t.data.attributes.intermediary,this.error=null,this.updateOpponent(this.opponent),[3,3];case 2:return e=n.sent(),this.error=e,[3,3];case 3:return[2]}})})},t.prototype.onErrorSet=function(){this.isError=!!this.error},t.prototype.handleChange=function(t,e){this[e]=t.target.value},t.prototype.fetchMatchmake=function(){return tslib_1.__awaiter(this,void 0,void 0,function(){return tslib_1.__generator(this,function(t){return this.standalone?[2,{data:{type:"matchmaking",id:"2b83cb14-c7aa-5208-8da8-369aeb1a3f24",attributes:{intermediary:this.account.multisigAddress},relationships:{users:{data:{type:"users",id:this.account.user.id}},matchedUser:{data:{type:"matchedUsers",id:"3d54b508-b355-4323-8738-4cdf7290a2fd"}}}},included:[{type:"users",id:this.account.user.id,attributes:{username:this.account.user.username,ethAddress:this.account.user.ethAddress}},{type:"matchedUsers",id:"3d54b508-b355-4323-8738-4cdf7290a2fd",attributes:{username:"MyOpponent",ethAddress:"0x12345"}}]}]:[2,new Promise(function(t){var e=function(n){if(n.data.toString().startsWith("playground:response:matchmake")){window.removeEventListener("message",e);var s=n.data.split("|");t(JSON.parse(s[1]))}};window.addEventListener("message",e),window.parent.postMessage("playground:request:matchmake","*")})]})})},t.prototype.render=function(){var t=this;return this.isWaiting?h("app-waiting",{myName:this.myName,betAmount:this.betAmount,opponentName:this.opponent.attributes.username,isProposing:!0}):h("div",{class:"wrapper"},h("div",{class:"wager"},h("div",{class:"message"},h("img",{class:"message__icon",src:"/assets/images/logo.svg",alt:"High Roller"}),h("h1",{class:"message__title"},"Welcome!"),h("p",{class:"message__body"},"Ready to play?")),h("form",{class:"form",onSubmit:function(e){return t.handlePlay(e)}},h("label",{htmlFor:"myName"},"Your Name"),h("input",{class:"form__input",id:"myName",type:"text",placeholder:"Your name",value:this.myName,onInput:function(e){return t.handleChange(e,"myName")},readOnly:!0}),h("label",{htmlFor:"betAmount"},"Bet Amount ( ETH )"),h("input",{class:"form__input",id:"betAmount",type:"number",placeholder:"0.01",value:this.betAmount,onInput:function(e){return t.handleChange(e,"betAmount")},min:0,max:.01,step:1e-8}),this.isError?h("label",{class:"message__error"},this.error instanceof Error?this.error.message+": "+this.error.stack:this.error):{},h("button",{class:"form__button"},h("div",null,"Play!")))))},Object.defineProperty(t,"is",{get:function(){return"app-wager"},enumerable:!0,configurable:!0}),Object.defineProperty(t,"encapsulation",{get:function(){return"shadow"},enumerable:!0,configurable:!0}),Object.defineProperty(t,"properties",{get:function(){return{account:{type:"Any",attr:"account"},appFactory:{type:"Any",attr:"app-factory"},betAmount:{state:!0},el:{elementRef:!0},error:{state:!0,watchCallbacks:["onErrorSet"]},history:{type:"Any",attr:"history"},intermediary:{state:!0},isError:{state:!0},isWaiting:{state:!0},myName:{state:!0},opponent:{state:!0},standalone:{type:Boolean,attr:"standalone"},updateAppInstance:{type:"Any",attr:"update-app-instance"},updateOpponent:{type:"Any",attr:"update-opponent"}}},enumerable:!0,configurable:!0}),Object.defineProperty(t,"style",{get:function(){return"/**style-placeholder:app-wager:**/"},enumerable:!0,configurable:!0}),t}();CounterfactualTunnel.injectProps(AppWager,["appFactory","updateAppInstance","account","opponent","standalone"]);var AppWaiting=function(){function t(){this.el={},this.history={},this.myName="",this.betAmount="",this.opponentName="",this.isProposing=!1,this.seconds=60,this.isCountdownStarted=!1}return t.prototype.componentWillLoad=function(){this.betAmount=getProp("betAmount",this),this.isProposing=getProp("isProposing",this)},t.prototype.componentDidLoad=function(){this.setupWaiting()},t.prototype.countDown=function(){var t=this;1!==this.seconds&&setTimeout(function(){t.seconds=t.seconds-1,t.countDown()},1e3)},t.prototype.goToGame=function(t,e){console.log("GO TO GAME: "+t),this.history.push({pathname:"/game",state:{appInstanceId:e,opponentName:t,betAmount:this.betAmount,myName:this.myName,isProposing:this.isProposing},query:{},key:""})},t.prototype.startCountdown=function(){this.isCountdownStarted||(this.isCountdownStarted=!0,this.countDown())},t.prototype.setupWaiting=function(t,e,n,s){this.isProposing?this.setupWaitingProposing():this.setupWaitingAccepting()},t.prototype.setupWaitingProposing=function(){this.isCountdownStarted||this.startCountdown()},t.prototype.setupWaitingAccepting=function(){var t=this;this.cfProvider.once("updateState",function(){t.goToGame(t.opponentName,t.appInstance.id)}),this.myName=this.account.user.username,this.opponentName=this.opponent.attributes.username},t.prototype.render=function(){return h("div",{class:"wrapper"},h("div",{class:"waiting"},h("div",{class:"message"},h("img",{class:"message__icon",src:"/assets/images/logo.svg",alt:"High Roller"}),h("h1",{class:"message__title"},"Waiting Room"),h("p",{class:"message__body"},this.isProposing?"Waiting for another player to join the game in":"Waiting on "+this.opponentName+"'s roll..."),this.isProposing?h("p",{class:"countdown"},this.seconds):{},h("p",null,"Player: ",this.myName," ",h("br",null),"Opponent: ",this.opponentName," ",h("br",null),"Bet Amount: ",this.betAmount," ETH"))))},Object.defineProperty(t,"is",{get:function(){return"app-waiting"},enumerable:!0,configurable:!0}),Object.defineProperty(t,"encapsulation",{get:function(){return"shadow"},enumerable:!0,configurable:!0}),Object.defineProperty(t,"properties",{get:function(){return{account:{type:"Any",attr:"account"},appInstance:{type:"Any",attr:"app-instance"},betAmount:{type:String,attr:"bet-amount",mutable:!0},cfProvider:{type:"Any",attr:"cf-provider"},el:{elementRef:!0},history:{type:"Any",attr:"history"},isCountdownStarted:{state:!0},isProposing:{type:Boolean,attr:"is-proposing",mutable:!0},myName:{type:String,attr:"my-name",mutable:!0},opponent:{type:"Any",attr:"opponent"},opponentName:{type:String,attr:"opponent-name",mutable:!0},seconds:{state:!0}}},enumerable:!0,configurable:!0}),Object.defineProperty(t,"style",{get:function(){return"/**style-placeholder:app-waiting:**/"},enumerable:!0,configurable:!0}),t}();CounterfactualTunnel.injectProps(AppWaiting,["cfProvider","appInstance","account","opponent"]);export{AppWager,AppWaiting};